<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GIS Cobertura CR v6.6 (Motor de Muestreo Espacial)</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="icon" type="image/x-icon" href="https://www.sirefor.go.cr/images/favicon.ico">
<link rel="apple-touch-icon" href="https://www.sirefor.go.cr/images/favicon.ico">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* RESET & BASE */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --primary-h: 145; --primary-s: 65%; --primary-l: 25%;
  --primary: hsl(var(--primary-h), var(--primary-s), var(--primary-l));
  --primary-hover: hsl(var(--primary-h), var(--primary-s), 20%);
  --primary-light: hsl(var(--primary-h), 40%, 94%); 
  --info: #0277BD; --info-bg: #E1F5FE;
  --surface: #ffffff; --surface-2: #f8f9fa; --bg: #eceff1; --border: #e0e0e0;
  --text-main: #263238; --text-muted: #546E7A;
  --danger: #d32f2f; --danger-bg: #fbe9e7;
  --warn: #f57c00; --warn-bg: #fff3e0;
  --success: #2e7d32; --success-bg: #e8f5e9;
  --radius: 8px;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
  --font-main: 'DM Sans', system-ui, sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --header-height: 56px; --footer-height: 32px;
}
:root[data-theme="dark"]{
  --primary: #4CAF50; --primary-hover: #66BB6A; --primary-light: rgba(76, 175, 80, 0.15);
  --info: #29B6F6; --info-bg: rgba(41, 182, 246, 0.15);
  --surface: #1e293b; --surface-2: #334155; --bg: #0f172a; --border: #475569;
  --text-main: #f1f5f9; --text-muted: #94a3b8;
  --danger: #ef5350; --danger-bg: rgba(239, 83, 80, 0.15);
  --warn: #ffa726; --warn-bg: rgba(255, 167, 38, 0.15);
}
html,body{height:100%;font-family:var(--font-main);font-size:14px;color:var(--text-main);background:var(--bg);transition:background .3s ease, color .3s ease;overflow:hidden;-webkit-font-smoothing: antialiased;}
button { font-family:var(--font-main); cursor:pointer; border:none; border-radius:var(--radius); padding: 0 16px; height: 36px; font-size:13px; font-weight:500; transition: all .2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
button:active { transform: translateY(1px); }
.btn-primary { background: var(--primary); color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.btn-primary:hover { background: var(--primary-hover); }
.btn-secondary { background: var(--surface); color: var(--text-main); border: 1px solid var(--border); }
.btn-secondary:hover { background: var(--surface-2); border-color: var(--text-muted); }
.btn-danger { background: var(--danger-bg); color: var(--danger); border: 1px solid transparent; }
.btn-danger:hover { background: var(--danger); color: white; }
.btn-sm { height: 28px; padding: 0 12px; font-size: 12px; }
.btn-block { width: 100%; }
.btn-icon-only { padding: 0; width: 28px; height: 28px; border-radius: 4px; }
input, select, textarea { font-family: var(--font-main); font-size: 13px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); color: var(--text-main); width: 100%; }
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
label { font-weight: 600; font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px; display: block;}
textarea { resize: vertical; min-height: 80px; font-family: var(--font-mono); }
#app { display: flex; height: 100vh; width: 100vw; overflow: hidden; }
#map-container { flex: 1; position: relative; display: flex; flex-direction: column; min-width: 0; }
#map { flex: 1; background: #ddd; z-index: 1; }
#map.drawing-mode { cursor: crosshair !important; }
#sidebar { width: 360px; min-width: 300px; max-width: 60vw; display: flex; flex-direction: column; background: var(--surface); border-left: 1px solid var(--border); position: relative; z-index: 20; box-shadow: -2px 0 10px rgba(0,0,0,0.05); }
#sidebar-header { height: var(--header-height); padding: 0 20px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.brand h2 { font-size: 16px; font-weight: 700; margin: 0; display: block; }
.brand { display: flex; align-items: center; gap: 10px; min-width: 0; }
.brand-text { display: flex; flex-direction: column; line-height: 1.15; min-width: 0; }
.brand-sub { font-size: 11px; font-weight: 600; color: var(--text-muted); white-space: normal; }
.brand-sub-mono { font-family: var(--font-mono); font-weight: 500; font-size: 10.5px; }

.badge { background: var(--primary-light); color: var(--primary); font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 12px; }
#topbar { display: flex; padding: 0 16px; background: var(--surface); border-bottom: 1px solid var(--border); height: 48px; gap: 12px; }
.tab { display: flex; align-items: center; gap: 8px; font-weight: 500; font-size: 13px; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; padding: 0 4px; }
.tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }
#content { flex: 1; overflow-y: auto; padding: 20px; background: var(--bg); }
.card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow-sm); }
.card h3 { font-size: 13px; font-weight: 700; margin-bottom: 16px; text-transform: uppercase; border-left: 3px solid var(--primary); padding-left: 10px; }
.wizard-header { margin-bottom: 20px; }
.wizard-progress { display: flex; gap: 4px; margin-bottom: 12px; }
.progress-step { flex: 1; height: 6px; background: var(--border); border-radius: 3px; }
.progress-step.active { background: var(--primary); }
.wizard-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 12px; }
.wizard-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 8px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; }
.wizard-card.selected { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
.wizard-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.back-btn { color: var(--text-muted); font-size: 12px; font-weight: 600; cursor: pointer; }
.legacy-input-container { display: none; } 
.inventory-summary { display: flex; gap: 8px; margin-bottom: 12px; }
.inv-badge { flex: 1; padding: 6px; background: var(--info-bg); color: var(--info); border-radius: 20px; text-align: center; font-size: 11px; font-weight: 700; cursor: pointer; }
.inv-badge.active { background: var(--info); color: white; }
.data-list { max-height: 200px; overflow-y: auto; background: var(--surface-2); border-radius: var(--radius); margin-bottom: 12px; display: none; }
.data-list.show { display: block; }
.data-item { padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 12px; font-family: var(--font-mono); display: flex; justify-content: space-between; align-items: center;}
#status-bar { height: var(--footer-height); background: rgba(255, 255, 255, 0.95); border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; font-family: var(--font-mono); font-size: 11px; }
:root[data-theme="dark"] #status-bar { background: rgba(30, 41, 59, 0.95); }
.scale-input-wrapper { display: flex; align-items: center; border: 1px solid var(--border); border-radius: 4px; padding: 2px 6px; }
#numeric-scale { background: transparent; border: none; width: 60px; padding: 0; text-align: right; color: var(--primary); font-weight: 700;}
#map-controls-custom { position: absolute; top: 16px; left: 16px; z-index: 1000; display:flex; flex-direction:column; gap:8px;}
.map-btn { width: 36px; height: 36px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: var(--shadow-md); font-size:18px;}
#drawing-tooltip { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: var(--text-main); color: var(--surface); padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 12px; z-index: 2000; display: none; }
#layers-panel { position: absolute; top: 16px; left: 60px; width: 320px; max-height: 80vh; background: var(--surface); border-radius: var(--radius); z-index: 2000; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border); box-shadow: var(--shadow-lg);}
#layers-panel.hidden { display: none; }
#layers-panel-header { padding: 12px 16px; background: var(--surface-2); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
#layers-panel-content { padding: 0; overflow-y: auto; flex: 1; }
.layer-section { padding: 12px 16px; border-bottom: 1px solid var(--border); }
.layer-section h4 { margin: 0 0 10px 0; font-size: 11px; font-weight: 700; color: var(--text-muted); }
.panel { display: none; } .panel.active { display: block; }
.report-section { margin-bottom: 30px; }
.report-table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius); }
.report-table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: left; }
.report-table th, .report-table td { padding: 8px; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); }
.report-table th { background: var(--surface-2); font-weight: 700; }
.spinner-container { display: flex; flex-direction: column; align-items: center; padding: 40px; }
.loader { border: 4px solid var(--surface-2); border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
#resizer-handle { position: absolute; top: 0; left: 0; bottom: 0; width: 4px; cursor: col-resize; z-index: 100; }
@media(max-width:900px){
  #sidebar{width:100%; height:45vh; border-left:none; border-top:1px solid var(--border)}
  #resizer-handle { cursor: row-resize; top: -4px; height: 8px; width: 100%; }
  #app{flex-direction:column}
}
</style>
</head>
<body>
<div id="app">
  <div id="map-container">
    <div id="map">
        <div id="drawing-tooltip">Modo Dibujo Activo</div>
        <div id="map-controls-custom">
            <button class="map-btn" onclick="toggleLayersPanel()" title="Capas">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
            </button>
        </div>
        <div id="layers-panel" class="hidden">
            <div id="layers-panel-header">
                <h3 style="font-size:13px; margin:0;">Capas del Mapa</h3>
                <button class="btn-sm btn-secondary" onclick="toggleLayersPanel()">‚úï</button>
            </div>
            <div style="padding: 10px; border-bottom: 1px solid var(--border); background: var(--surface-2);">
                <input type="text" id="layer-search" placeholder="Buscar capa..." onkeyup="filterLayers(this.value)" style="padding: 6px 10px; font-size: 12px;">
            </div>
            <div id="layers-panel-content"></div>
        </div>
    </div>
    <div id="status-bar">
        <div><span id="coord-wgs">Lat: - Lon: -</span> | <span id="coord-crtm">E: - N: -</span></div>
        <div class="scale-input-wrapper">Escala 1: <input id="numeric-scale" value="-"></div>
    </div>
  </div>

  <div id="sidebar">
    <div id="resizer-handle"></div>
    <div id="sidebar-header">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
        <div class="brand-text">
          <h2>GIS Cobertura CR</h2>
          <div class="brand-sub">Ing. Pablo S√°nchez, SINAC / ACOPAC</div>
          <div class="brand-sub brand-sub-mono">Mail pablo.sanchez@sinac.go.cr / Phone (506) 6126-7123</div>
        </div>
      </div>
      <div><span class="badge">v6.6+</span> <button class="btn-secondary btn-icon-only" onclick="toggleTheme()" title="Cambiar Tema">‚óë</button></div>
    </div>
    <div id="topbar">
      <div class="tab active" data-tab="data" onclick="switchMainTab('data')">üìÅ Datos</div>
      <div class="tab" data-tab="results" onclick="switchMainTab('results')">üìä Resultados</div>
      <div class="tab" data-tab="config" onclick="switchMainTab('config')">‚öô Config</div>
    </div>

    <div id="content">
      <div id="panel-data" class="panel active">
          <div id="wizard-container">
              <div class="wizard-header">
                  <div class="wizard-nav"><div class="back-btn" id="wizard-back" onclick="prevStep()" style="display:none">‚Üê Volver</div> <span id="step-text" style="font-size:11px;font-weight:bold;">Paso 1/3</span></div>
                  <div class="wizard-progress"><div class="progress-step active" id="p-step-1"></div><div class="progress-step" id="p-step-2"></div><div class="progress-step" id="p-step-3"></div></div>
                  <h3 id="step-title" style="font-size:14px;">Seleccione M√©todo</h3>
              </div>
              <div id="wizard-step-1" class="wizard-step-content">
                  <div class="wizard-cards-grid">
                      <div class="wizard-card" onclick="selectMethod('manual')"><span style="font-size:24px;">‚úèÔ∏è</span> Dibujar</div>
                      <div class="wizard-card" onclick="selectMethod('import')"><span style="font-size:24px;">üìÇ</span> Importar</div>
                      <div class="wizard-card" onclick="selectMethod('paste')"><span style="font-size:24px;">üìã</span> Pegar</div>
                  </div>
              </div>
              <div id="wizard-step-2" class="wizard-step-content" style="display:none;">
                  <div class="wizard-cards-grid">
                      <div class="wizard-card" onclick="selectGeometry('point')"><span style="font-size:24px;">‚óè</span> Punto</div>
                      <div class="wizard-card" onclick="selectGeometry('line')"><span style="font-size:24px;">‚ï±</span> L√≠nea</div>
                      <div class="wizard-card" onclick="selectGeometry('polygon')"><span style="font-size:24px;">‚¨°</span> Pol√≠gono</div>
                  </div>
              </div>
              <div id="wizard-step-3" class="wizard-step-content" style="display:none;">
                  <div id="active-form-container"></div>
                  <button class="btn-secondary btn-block" onclick="resetWizard()" style="margin-top:16px;">‚Ü© Iniciar Nuevo Elemento</button>
              </div>
          </div>

          <div id="legacy-panels-storage" style="display:none;">
              <div id="input-manual" class="legacy-input-container">
                  <div class="card">
                      <div style="display: grid; grid-template-columns: 1fr 100px; gap: 12px; margin-bottom: 12px;">
                          <div><label>ID</label><input id="man-id" placeholder="Ej: P1"></div>
                          <div><label>EPSG</label><select id="man-epsg"><option value="8908">8908</option><option value="4326">4326</option></select></div>
                      </div>
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                          <div><label>X / Lon</label><input id="man-x" type="number" step="any"></div>
                          <div><label>Y / Lat</label><input id="man-y" type="number" step="any"></div>
                      </div>
                      <div style="display:flex; gap:12px;">
                          <button class="btn-primary" style="flex:1" onclick="manualAction()">‚ûï Agregar</button>
                          <button class="btn-secondary" style="flex:1" id="btn-draw-map" onclick="toggleDrawingMode()">‚úèÔ∏è Dibujar</button>
                      </div>
                      <div id="poly-controls" style="display:none; gap:8px; margin-top:8px">
                           <button class="btn-primary btn-block" onclick="finishGeometry()">üèÅ Finalizar</button>
                           <button class="btn-danger" onclick="cancelGeometry()">‚úï</button>
                      </div>
                      <div id="manual-status" style="margin-top:8px; font-size:12px; font-weight:bold;"></div>
                  </div>
              </div>
              <div id="input-import" class="legacy-input-container">
                  <div class="card">
                      <p style="font-size:12px; color:var(--text-muted); margin-bottom:12px;">Soporta: .ZIP (SHP), .GPX, .GEOJSON, .KML</p>
                      <input type="file" id="file-upload" accept=".zip,.gpx,.json,.geojson,.kml" style="margin-bottom:12px;">
                      <select id="file-epsg" style="margin-bottom:12px;"><option value="8908">8908 (CRTM05)</option><option value="4326">4326 (WGS84)</option></select>
                      <button class="btn-primary btn-block" onclick="importUniversalFile()">üì• Cargar Archivo</button>
                      <div id="import-status" style="margin-top:8px; font-size:12px; font-weight:bold;"></div>
                  </div>
              </div>
              <div id="input-paste" class="legacy-input-container">
                  <div class="card">
                      <textarea id="paste-area" placeholder="Formato: ID, X, Y (separado por tabulador o coma)"></textarea>
                      <select id="paste-epsg" style="margin:12px 0;"><option value="8908">8908</option><option value="4326">4326</option></select>
                      <button class="btn-primary btn-block" onclick="processPaste()">Procesar Texto</button>
                  </div>
               </div>
          </div>

          <div class="card" style="margin-top:20px;">
              <h3>Inventario</h3>
              <div class="inventory-summary">
                  <div class="inv-badge" id="badge-points" onclick="toggleList('points')">0 Puntos</div>
                  <div class="inv-badge" id="badge-lines" onclick="toggleList('lines')">0 L√≠neas</div>
                  <div class="inv-badge" id="badge-polys" onclick="toggleList('polys')">0 Pol√≠gonos</div>
              </div>
              <div id="list-points" class="data-list"></div>
              <div id="list-lines" class="data-list"></div>
              <div id="list-polys" class="data-list"></div>
              <div style="display:flex; gap:12px; margin-top:16px;">
                  <button class="btn-secondary" style="flex:1" onclick="clearAllData()">üóë Limpiar</button>
                  <button class="btn-primary" style="flex:1.5" onclick="switchToResults()">üîç Analizar Todo</button>
              </div>
          </div>
      </div>

      <div id="panel-results" class="panel">
          <div class="card">
              <h3>Resultados del An√°lisis</h3>
              <div id="report-container"><p style="text-align:center; padding:30px;">Sin resultados.</p></div>
              <button class="btn-primary btn-block" onclick="downloadReport()" id="btn-download-report" style="display:none; margin-top:16px;">üì• Descargar XLSX</button>
          </div>
      </div>

      <div id="panel-config" class="panel">
          <div class="card">
              <h3>Configuraci√≥n WFS</h3>
              <div id="config-list"></div>
              <div style="margin-top:20px; border-top:1px dashed var(--border); padding-top:16px;">
                  <h4 style="font-size:12px; margin-bottom:8px;">Agregar Capa</h4>
                  <input id="new-name" placeholder="Nombre" style="margin-bottom:8px;">
                  <input id="new-url" placeholder="URL WFS" style="margin-bottom:8px;">
                  <input id="new-type" placeholder="TypeName" style="margin-bottom:8px;">
                  <input id="new-attr" placeholder="Atributo" style="margin-bottom:8px;">
                  <select id="new-srs" style="margin-bottom:12px;"><option value="EPSG:4326">EPSG:4326</option><option value="EPSG:8908">EPSG:8908</option></select>
                  <button class="btn-primary btn-block" onclick="addNewLayer()">‚ûï Agregar</button>
              </div>
              <div style="display:flex; gap:12px; margin-top:16px;">
                  <button class="btn-secondary" style="flex:1" onclick="resetConfig()">Restaurar Default</button>
              </div>
          </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.2/proj4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsts/2.9.3/jsts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shpjs/4.0.4/shp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
proj4.defs("EPSG:8908", "+proj=tmerc +lat_0=0 +lon_0=-84 +k=0.9999 +x_0=500000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
proj4.defs("EPSG:4326", "+proj=longlat +datum=WGS84 +no_defs");

let map; let layerControl; let layers = {}; let activeWmsLayers = {}; 
let data = { points: [], lines: [], polygons: [] };
let tempGeom = { type: 'point', vertices: [], id: '' };
let appState = { inputMethod: 'manual', geoType: 'point', isDrawing: false };
let wizardState = { step: 1, method: null, geoType: null };
let listState = { points: false, lines: false, polys: false };
let globalAnalysisResults = null;

const DEFAULT_LAYERS = [
  { id: 'fona2000', name: 'FONAFIFO 2000', wfs: 'https://www.sirefor.go.cr/GeoserviciosSIREFOR/wfs', type: 'cobertura_forestal2000', attr: 'USO_COBERT', srs: 'EPSG:4326', enabled: true },
  { id: 'fona2005', name: 'FONAFIFO 2005', wfs: 'https://www.sirefor.go.cr/GeoserviciosSIREFOR/wfs', type: 'cobertura_forestal2005', attr: 'cobertura', srs: 'EPSG:4326', enabled: true },
  { id: 'pne2021', name: 'COB. PNE 2021', wfs: 'https://geos1pne.sirefor.go.cr/wfs', type: 'PNE:cobertura_forestal_2021', attr: 'Clase', srs: 'EPSG:8908', enabled: true },
  { id: 'pne2023', name: 'COB. PNE 2023', wfs: 'https://geos1pne.sirefor.go.cr/wfs', type: 'PNE:cobertura_forestal_2023', attr: 'Clase', srs: 'EPSG:8908', enabled: true }
];
let config = JSON.parse(localStorage.getItem('giscr_config') || JSON.stringify(DEFAULT_LAYERS));

const OGC_PROXY_BASE = 'https://ocg-psfor.psforestal.workers.dev/ogc?u=';
const INCHES_PER_METER = 39.3701;
const DPI = 96;

// ==========================================
// CORE INIT
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    initMap(); initTheme(); renderConfig(); loadDataFromStorage(); renderWizard();
    initResizer(); initScaleInput();
    document.addEventListener('keydown', (e) => {
        if (!appState.isDrawing) return;
        if (e.key === 'Escape') cancelGeometry();
        if (e.key === 'Enter') finishGeometry();
        if (e.key === 'Delete' || e.key === 'Backspace') {
            if (tempGeom.vertices.length > 0) { tempGeom.vertices.pop(); drawTempGeom(); }
        }
    });
});

function initMap() {
    map = L.map('map', { zoomControl: false }).setView([9.95, -84.1], 8);
    L.control.zoom({ position: 'topright' }).addTo(map);
    
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:22, attribution:'Esri'});
    satellite.addTo(map);

    layers.points = L.featureGroup().addTo(map); 
    layers.lines = L.featureGroup().addTo(map); 
    layers.polys = L.featureGroup().addTo(map); 
    layers.temp = L.featureGroup().addTo(map);

    window.__basemaps = { "Sat√©lite": satellite };
    window.__overlays = { "Puntos": layers.points, "L√≠neas": layers.lines, "Pol√≠gonos": layers.polys };
    updateMapWmsLayers();

    map.on('click', onMapClick); 
    map.on('dblclick', (e) => { if(appState.isDrawing) finishGeometry(); });
    map.on('moveend zoomend', updateScaleControl);
    map.on('mousemove', e => { 
        const p8908 = proj4("EPSG:4326", "EPSG:8908", [e.latlng.lng, e.latlng.lat]); 
        document.getElementById('coord-wgs').innerText = `Lat: ${e.latlng.lat.toFixed(5)} Lon: ${e.latlng.lng.toFixed(5)}`; 
        document.getElementById('coord-crtm').innerText = `E: ${p8908[0].toFixed(2)} N: ${p8908[1].toFixed(2)}`; 
    });
}

function initResizer() { 
    const handle = document.getElementById('resizer-handle'); 
    const sidebar = document.getElementById('sidebar'); 
    let isResizing = false; 
    handle.addEventListener('mousedown', () => { isResizing = true; }); 
    document.addEventListener('mousemove', (e) => { 
        if (!isResizing) return; 
        let w = window.innerWidth - e.clientX; 
        sidebar.style.width = Math.max(280, w) + 'px'; 
        map.invalidateSize(); 
    }); 
    document.addEventListener('mouseup', () => { isResizing = false; }); 
}

function getMapScale() { 
    const center = map.getCenter(); 
    const metersPerPixel = 156543.03392 * Math.cos(center.lat * Math.PI / 180) / Math.pow(2, map.getZoom()); 
    return metersPerPixel * INCHES_PER_METER * DPI; 
}
function updateScaleControl() { 
    const input = document.getElementById('numeric-scale'); 
    if (document.activeElement !== input) input.value = Math.round(getMapScale()).toLocaleString('es-CR'); 
}
function initScaleInput() { 
    const input = document.getElementById('numeric-scale'); 
    input.addEventListener('keydown', (e) => { 
        if (e.key === 'Enter') { 
            const val = parseFloat(input.value.replace(/[^0-9.]/g, '')); 
            if (val > 0) {
                const center = map.getCenter(); 
                const metersPerPixel = val / (INCHES_PER_METER * DPI); 
                const zoom = Math.log2((156543.03392 * Math.cos(center.lat * Math.PI / 180)) / metersPerPixel); 
                map.setZoom(zoom);
            }
            input.blur(); 
        } 
    }); 
}

// ==========================================
// CAPAS Y ESTILOS
// ==========================================
function toggleTheme() { 
    const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; 
    document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); 
}
function initTheme() { document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light'); }

function toggleLayersPanel() { 
    const p = document.getElementById('layers-panel'); 
    p.classList.toggle('hidden'); 
    if (!p.classList.contains('hidden')) renderLayersPanel();
}
function renderLayersPanel() {
    const container = document.getElementById('layers-panel-content'); 
    container.innerHTML = ''; 
    const wmsSec = document.createElement('div'); wmsSec.className = 'layer-section';
    wmsSec.innerHTML = '<h4>Coberturas WMS</h4>';
    config.forEach(c => { 
        if (!c.enabled) return; 
        const layer = activeWmsLayers[c.id]; 
        if (!layer) return; 
        const div = document.createElement('div');
        div.className = 'layer-item';
        div.style.marginBottom = '8px';
        div.innerHTML = `<label style="display:flex; justify-content:space-between; text-transform:none; font-weight:normal; font-size:12px;">
            <span>${c.name}</span>
            <input type="checkbox" ${map.hasLayer(layer) ? 'checked' : ''} onchange="toggleWms('${c.id}', this.checked)">
        </label>`;
        wmsSec.appendChild(div);
    });
    container.appendChild(wmsSec);
}
function filterLayers(text) {
    const term = text.toLowerCase();
    document.querySelectorAll('.layer-item').forEach(el => {
        el.style.display = el.innerText.toLowerCase().includes(term) ? 'block' : 'none';
    });
}
window.toggleWms = (id, active) => { 
    const layer = activeWmsLayers[id]; 
    if (active) map.addLayer(layer); else map.removeLayer(layer); 
};
function updateMapWmsLayers() { 
    config.forEach(c => { 
        if (!c.enabled) {
            if(activeWmsLayers[c.id]) { map.removeLayer(activeWmsLayers[c.id]); delete activeWmsLayers[c.id]; }
            return;
        }
        if (!activeWmsLayers[c.id]) {
            let wmsUrl = c.wfs.endsWith('/wfs') ? c.wfs.substring(0, c.wfs.length - 4) + '/wms' : c.wfs;
            activeWmsLayers[c.id] = L.tileLayer.wms(wmsUrl, { layers: c.type, format: 'image/png', transparent: true, opacity: 0.75 });
            activeWmsLayers[c.id].addTo(map);
        }
    }); 
}

// ==========================================
// WIZARD Y PESTA√ëAS
// ==========================================
function switchMainTab(t) { 
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active')); 
    document.querySelector(`[data-tab="${t}"]`).classList.add('active'); 
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); 
    document.getElementById(`panel-${t}`).classList.add('active'); 
    if(t === 'results') triggerSpatialAnalysis(); 
}
  // Funci√≥n para el bot√≥n "Analizar Todo"
function switchToResults() {
    switchMainTab('results');
}
function renderWizard() {
    document.querySelectorAll('.wizard-step-content').forEach(e => e.style.display = 'none');
    document.getElementById(`wizard-step-${wizardState.step}`).style.display = 'block';
    document.getElementById('step-text').innerText = `Paso ${wizardState.step}/3`;
    document.getElementById('wizard-back').style.display = wizardState.step > 1 ? 'flex' : 'none';
    if(wizardState.step === 3) {
        const c = document.getElementById('active-form-container');
        const s = document.getElementById('legacy-panels-storage');
        while(c.firstChild) s.appendChild(c.firstChild);
        const t = document.getElementById(`input-${wizardState.method}`);
        t.style.display = 'block'; c.appendChild(t);
        
        if (wizardState.method === 'manual') {
             document.getElementById('man-id').value = (appState.geoType === 'point' ? 'P' : appState.geoType === 'line' ? 'L' : 'POL') + (data[appState.geoType + 's'] || data.polygons).length;
        }
    }
}
function selectMethod(m) { wizardState.method = m; appState.inputMethod = m; wizardState.step = m==='import'?3:2; renderWizard(); }
function selectGeometry(t) { wizardState.geoType = t; appState.geoType = t; wizardState.step = 3; renderWizard(); }
function prevStep() { wizardState.step = wizardState.step === 3 && wizardState.method === 'import' ? 1 : wizardState.step - 1; renderWizard(); }
function resetWizard() { wizardState.step = 1; wizardState.method = null; wizardState.geoType = null; renderWizard(); cancelGeometry(); }

// ==========================================
// DIBUJO MANUAL Y CAPTURA
// ==========================================
function transformTo8908(x, y, fromEpsg) { 
    if (fromEpsg === '8908') return [x, y]; 
    return proj4(`EPSG:${fromEpsg}`, "EPSG:8908", [x, y]); 
}

function toggleDrawingMode() { 
    appState.isDrawing = !appState.isDrawing; 
    const mapEl = document.getElementById('map');
    const btn = document.getElementById('btn-draw-map');
    if(appState.isDrawing) {
        mapEl.classList.add('drawing-mode');
        document.getElementById('drawing-tooltip').style.display = 'block';
        btn.classList.replace('btn-secondary', 'btn-primary');
        btn.innerText = "üõë Detener";
    } else {
        mapEl.classList.remove('drawing-mode');
        document.getElementById('drawing-tooltip').style.display = 'none';
        btn.classList.replace('btn-primary', 'btn-secondary');
        btn.innerText = "‚úèÔ∏è Dibujar";
    }
}

function onMapClick(e) { 
    if (!appState.isDrawing) return; 
    const p8908 = proj4("EPSG:4326", "EPSG:8908", [e.latlng.lng, e.latlng.lat]); 
    const idInput = document.getElementById('man-id');
    const id = idInput.value || 'ID'+Date.now();
    
    if (appState.geoType === 'point') { 
        addFeature('points', id, p8908); 
        document.getElementById('manual-status').innerText = `‚úî Punto ${id} agregado`;
        setTimeout(()=> document.getElementById('manual-status').innerText = '', 2000);
        idInput.value = 'P' + data.points.length;
    } else { 
        tempGeom.id = id; tempGeom.type = appState.geoType; tempGeom.vertices.push(p8908); 
        document.getElementById('poly-controls').style.display = 'flex';
        drawTempGeom(); 
        document.getElementById('manual-status').innerText = `V√©rtices: ${tempGeom.vertices.length}`;
    } 
}

function manualAction() {
    let x = parseFloat(document.getElementById('man-x').value); 
    let y = parseFloat(document.getElementById('man-y').value); 
    const id = document.getElementById('man-id').value || 'ID1';
    if (isNaN(x) || isNaN(y)) return alert('Coordenadas inv√°lidas');
    const c = transformTo8908(x, y, document.getElementById('man-epsg').value);
    if(appState.geoType === 'point') addFeature('points', id, c);
    else { tempGeom.id = id; tempGeom.vertices.push(c); drawTempGeom(); document.getElementById('poly-controls').style.display = 'flex'; }
}

function drawTempGeom() { 
    layers.temp.clearLayers(); 
    const ll = tempGeom.vertices.map(v => { const p = proj4("EPSG:8908", "EPSG:4326", v); return [p[1], p[0]]; }); 
    ll.forEach(p => L.circleMarker(p, {color:'orange', radius:4}).addTo(layers.temp)); 
    if(ll.length>1) L.polyline(ll, {color:'orange'}).addTo(layers.temp); 
}

function finishGeometry() { 
    if (tempGeom.vertices.length < (tempGeom.type==='line'?2:3)) return alert('Faltan v√©rtices para esta geometr√≠a');
    if (tempGeom.type === 'polygon' && (tempGeom.vertices[0][0] !== tempGeom.vertices[tempGeom.vertices.length-1][0])) {
        tempGeom.vertices.push(tempGeom.vertices[0]); // Cerrar pol√≠gono autom√°ticamente
    }
    addFeature(tempGeom.type === 'line' ? 'lines' : 'polygons', tempGeom.id, tempGeom.vertices); 
    cancelGeometry(); 
}
function cancelGeometry() { 
    tempGeom.vertices = []; layers.temp.clearLayers(); 
    document.getElementById('poly-controls').style.display = 'none'; 
    document.getElementById('manual-status').innerText = '';
    if(appState.isDrawing) toggleDrawingMode(); 
}

// ==========================================
// IMPORTAR ARCHIVOS Y PEGAR (FUNCI√ìN RESTAURADA)
// ==========================================
function getSampleCoord(g) { 
    if(g.type === 'Point') return g.coordinates; 
    if(g.type === 'LineString' || g.type === 'MultiPoint') return g.coordinates[0]; 
    if(g.type === 'Polygon' || g.type === 'MultiLineString') return g.coordinates[0][0]; 
    if(g.type === 'MultiPolygon') return g.coordinates[0][0][0]; 
    return null; 
}

async function importUniversalFile() { 
    const file = document.getElementById('file-upload').files[0]; 
    let srcEpsg = document.getElementById('file-epsg').value; 
    if (!file) return alert("Por favor selecciona un archivo."); 
    const status = document.getElementById('import-status'); 
    status.innerText = "Cargando e interpretando..."; 
    
    try { 
        const buf = await file.arrayBuffer(); 
        let geojson; 
        if (file.name.endsWith('.zip')) geojson = await shp(buf); 
        else if (file.name.endsWith('.kml')) geojson = toGeoJSON.kml(new DOMParser().parseFromString(new TextDecoder().decode(buf), 'text/xml')); 
        else if (file.name.endsWith('.gpx')) geojson = toGeoJSON.gpx(new DOMParser().parseFromString(new TextDecoder().decode(buf), 'text/xml')); 
        else geojson = JSON.parse(new TextDecoder().decode(buf)); 
        
        if (Array.isArray(geojson)) geojson = { features: geojson.flatMap(g => g.features || [g]) }; 
        if (!geojson.features) geojson = { features: [geojson] }; 
        
        // Autodetectar si las coordenadas parecen WGS84
        let detected4326 = false; 
        for(const f of geojson.features) { 
            if(!f.geometry) continue; 
            const c = getSampleCoord(f.geometry); 
            if(c && Math.abs(c[0]) <= 180 && Math.abs(c[1]) <= 90) { 
                detected4326 = true; break; 
            } 
        } 
        if(detected4326) srcEpsg = '4326'; 
        
        let stats = { p: 0, l: 0, poly: 0 }; 
        geojson.features.forEach(f => { 
            if (!f.geometry) return; 
            const id = f.properties?.name || f.properties?.id || f.properties?.ID || `IMP_${Math.floor(Math.random()*1000)}`; 
            const g = f.geometry; 
            const type = g.type; 
            
            if (type === 'Point') { 
                addFeature('points', id, transformTo8908(g.coordinates[0], g.coordinates[1], srcEpsg)); 
                stats.p++; 
            } else if (type === 'LineString' || type === 'MultiLineString') { 
                const lines = type === 'LineString' ? [g.coordinates] : g.coordinates; 
                lines.forEach((l, i) => { 
                    addFeature('lines', id + (i>0?`_${i+1}`:''), l.map(c => transformTo8908(c[0], c[1], srcEpsg))); 
                    stats.l++; 
                }); 
            } else if (type === 'Polygon' || type === 'MultiPolygon') { 
                const polys = type === 'Polygon' ? [g.coordinates] : g.coordinates; 
                polys.forEach((p, i) => { 
                    addFeature('polygons', id + (i>0?`_${i+1}`:''), p[0].map(c => transformTo8908(c[0], c[1], srcEpsg))); 
                    stats.poly++; 
                }); 
            } 
        }); 
        status.innerText = `Cargado con √©xito: ${stats.p} Puntos, ${stats.l} L√≠neas, ${stats.poly} Pol√≠gonos.`; 
        fitMapToAll(); 
    } catch(e) { 
        status.innerText = "Error leyendo archivo: " + e.message; 
        console.error(e); 
    } 
}

function processPaste() { 
    const text = document.getElementById('paste-area').value; 
    const epsg = document.getElementById('paste-epsg').value; 
    const type = appState.geoType; 
    const lines = text.split('\n'); 
    const groups = {}; 
    let count = 0; 
    
    lines.forEach(line => { 
        const p = line.split(/[\t,;]+/).map(s => s.trim()); 
        if (p.length < 3 || isNaN(parseFloat(p[1]))) return; 
        const id = p[0]; 
        const c = transformTo8908(parseFloat(p[1]), parseFloat(p[2]), epsg); 
        if (type === 'point') { 
            addFeature('points', id, c); 
            count++; 
        } else { 
            if (!groups[id]) groups[id] = []; 
            groups[id].push(c); 
        } 
    }); 
    
    if (type !== 'point') { 
        Object.keys(groups).forEach(id => { 
            let verts = groups[id]; 
            if (type === 'polygon' && verts.length >= 3) { 
                if (verts[0][0] !== verts[verts.length-1][0] || verts[0][1] !== verts[verts.length-1][1]) { 
                    verts.push(verts[0]); 
                } 
            } 
            if (verts.length >= 2) { 
                addFeature(type === 'line' ? 'lines' : 'polygons', id, verts); 
                count++; 
            } 
        }); 
    } 
    alert(`Se procesaron ${count} elementos correctamente.`); 
    fitMapToAll(); 
}

// ==========================================
// GESTION DE INVENTARIO Y MAPA (RESTAURADO)
// ==========================================
function fitMapToAll() { 
    const bounds = L.latLngBounds(); let valid = false; 
    [layers.points, layers.lines, layers.polys].forEach(l => { 
        if(l.getLayers().length){ bounds.extend(l.getBounds()); valid=true; } 
    }); 
    if(valid) map.fitBounds(bounds.pad(0.1)); 
}

function addFeature(type, id, geom) { 
    data[type].push({ id, geom }); drawFeature(type, {id, geom}); 
    localStorage.setItem('giscr_data', JSON.stringify(data)); updateInventory(); 
}

function drawFeature(type, item) {
    if (type === 'points') { 
        const p = proj4("EPSG:8908", "EPSG:4326", item.geom); 
        L.circleMarker([p[1], p[0]], {color:'#000', fillColor:'#FFEB3B', fillOpacity:1, weight:2, radius:6}).bindPopup(`<b>${item.id}</b>`).addTo(layers.points); 
    } else { 
        const ll = item.geom.map(v => { const p = proj4("EPSG:8908", "EPSG:4326", v); return [p[1], p[0]]; });
        if (type === 'lines') L.polyline(ll, {color:'#FF5722', weight:4}).bindPopup(`<b>${item.id}</b>`).addTo(layers.lines); 
        else L.polygon(ll, {color:'#00E5FF', weight:3, fillOpacity:0.2}).bindPopup(`<b>${item.id}</b>`).addTo(layers.polys); 
    }
}

function loadDataFromStorage() { 
    try { 
        const s = JSON.parse(localStorage.getItem('giscr_data')); 
        if(s) { data = s; ['points','lines','polygons'].forEach(t => { if(data[t]) data[t].forEach(i => drawFeature(t, i)); else data[t] = []; }); updateInventory(); }
    } catch(e){} 
}

function updateInventory() {
    document.getElementById('badge-points').innerText = `${data.points.length} Puntos`;
    document.getElementById('badge-lines').innerText = `${data.lines.length} L√≠neas`;
    document.getElementById('badge-polys').innerText = `${data.polygons.length} Pol√≠gonos`;
    
    const renderList = (type, elId) => {
        const c = document.getElementById(elId);
        c.innerHTML = data[type].map((item, idx) => `
            <div class="data-item">
                <span>${item.id}</span>
                <div style="display:flex; gap:4px;">
                    <button class="btn-secondary btn-icon-only" onclick="zoomToFeature('${type}', '${item.id}')">üëÅ</button>
                    <button class="btn-danger btn-icon-only" onclick="deleteFeature('${type}', ${idx})">üóë</button>
                </div>
            </div>
        `).join('');
    };
    renderList('points', 'list-points'); renderList('lines', 'list-lines'); renderList('polygons', 'list-polys');
}

function toggleList(t) { 
    const l = document.getElementById(`list-${t}`); 
    l.classList.toggle('show'); 
    listState[t] = l.classList.contains('show'); 
}

function zoomToFeature(type, id) { 
    const item = data[type].find(i => i.id === id); 
    if (!item) return; 
    if (type === 'points') { 
        const p = proj4("EPSG:8908", "EPSG:4326", item.geom); map.setView([p[1], p[0]], 18); 
    } else { 
        const ll = item.geom.map(v => { const p = proj4("EPSG:8908", "EPSG:4326", v); return [p[1], p[0]]; });
        map.fitBounds(L.latLngBounds(ll).pad(0.5)); 
    } 
}

function deleteFeature(type, index) { 
    if(!confirm('¬øEliminar elemento?')) return; 
    data[type].splice(index, 1); 
    const lType = type === 'polygons' ? 'polys' : type;
    layers[lType].clearLayers(); 
    data[type].forEach(item => drawFeature(type, item)); 
    localStorage.setItem('giscr_data', JSON.stringify(data));
    updateInventory(); 
}

function clearAllData() { 
    if(!confirm('¬øBorrar TODO el trabajo actual? Esto no se puede deshacer.')){ return; }
    data = { points:[], lines:[], polygons:[] }; 
    layers.points.clearLayers(); layers.lines.clearLayers(); layers.polys.clearLayers(); 
    localStorage.setItem('giscr_data', JSON.stringify(data)); 
    updateInventory(); 
}

// ==========================================
// CONFIGURACION
// ==========================================
function renderConfig() {
    const c = document.getElementById('config-list'); c.innerHTML = '';
    config.forEach((l, i) => {
        c.innerHTML += `<div style="margin-bottom:8px; padding:12px; border:1px solid var(--border); border-radius:4px; background:var(--surface-2);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label style="display:flex; align-items:center; gap:8px; font-weight:bold; margin:0; text-transform:none; font-size:13px;">
                    <input type="checkbox" ${l.enabled?'checked':''} onchange="config[${i}].enabled=this.checked; saveConfig(); updateMapWmsLayers();"> ${l.name}
                </label>
                <button class="btn-secondary btn-icon-only btn-sm" onclick="config.splice(${i},1); saveConfig(); renderConfig(); updateMapWmsLayers();" title="Borrar">üóë</button>
            </div>
            <div style="font-size:11px; color:var(--text-muted); margin-top:8px; font-family:var(--font-mono); word-break:break-all;">Type: ${l.type}<br>Attr: ${l.attr}</div>
        </div>`;
    });
}
function saveConfig() { localStorage.setItem('giscr_config', JSON.stringify(config)); }
function resetConfig() { if(confirm('¬øRestaurar configuraci√≥n original?')) { config = JSON.parse(JSON.stringify(DEFAULT_LAYERS)); saveConfig(); renderConfig(); updateMapWmsLayers(); } }
function addNewLayer() {
    const name = document.getElementById('new-name').value;
    const url = document.getElementById('new-url').value;
    const type = document.getElementById('new-type').value;
    const attr = document.getElementById('new-attr').value;
    const srs = document.getElementById('new-srs').value;
    if(!name || !url || !type || !attr) return alert("Llena todos los campos.");
    config.push({id:'u_'+Date.now(), name, wfs:url, type, attr, srs, enabled:true});
    saveConfig(); renderConfig(); updateMapWmsLayers();
    document.getElementById('new-name').value = ''; document.getElementById('new-type').value = ''; document.getElementById('new-attr').value = '';
}

// ==========================================
// NETWORK & WFS (WORKER PROXY ACTUALIZADO)
// ==========================================
async function fetchWithProxyFallback(targetUrl) {
    // Usamos EXCLUSIVAMENTE tu Worker de Cloudflare
    // Los proxies p√∫blicos (allorigins/corsproxy) fallan con GeoJSONs grandes de Costa Rica.
    const workerUrl = `https://ocg-psfor.psforestal.workers.dev/ogc?u=${encodeURIComponent(targetUrl)}`;
    
    try {
        console.log("üåê Consultando Worker Proxy:", workerUrl);
        const res = await fetch(workerUrl, {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (!res.ok) {
            // Si el Worker responde con un c√≥digo de error (502, etc), lo leemos
            const errText = await res.text();
            console.warn(`‚ö†Ô∏è Error del Worker (HTTP ${res.status}):`, errText);
            throw new Error(`HTTP ${res.status}: ${errText}`);
        }
        
        return await res.json();
    } catch (e) {
        console.error("‚ùå Fallo cr√≠tico en fetchWithProxyFallback:", e);
        // Devolvemos null para que fetchPointCoverage entienda que fall√≥ la red
        return null; 
    }
}

async function fetchPointCoverage(pGeom, c) {
    const pLayer = proj4('EPSG:8908', c.srs, pGeom);
    let tol = (c.srs === 'EPSG:4326') ? 0.00001 : 1;
    const bbox = `${pLayer[0]-tol},${pLayer[1]-tol},${pLayer[0]+tol},${pLayer[1]+tol},${c.srs}`;
    
    const url = `${c.wfs}?service=WFS&version=1.0.0&request=GetFeature&typeName=${c.type}&outputFormat=application/json&bbox=${bbox}&maxFeatures=1`;
    
    try {
        const geojson = await fetchWithProxyFallback(url);
        
        if (!geojson) return 'ERROR_RED'; // Manejo de la ca√≠da del proxy

        if (geojson.features && geojson.features.length > 0) {
            const props = geojson.features[0].properties;
            const searchKey = c.attr.toLowerCase();
            const key = Object.keys(props).find(k => k.toLowerCase() === searchKey);
            return key && props[key] != null ? String(props[key]) : 'SIN_DATO';
        }
        return 'SIN_DATO';
    } catch (e) {
        console.error("Error en fetchPointCoverage:", e);
        return 'ERROR_RED';
    }
}

async function fetchLineCoverages(lineGeom, c, lineId, updateStatus) {
    let results = {};
    for(let i=0; i<lineGeom.length; i++) {
        await updateStatus(`üìç Analizando V√©rtice ${i+1}/${lineGeom.length} de L√≠nea ${lineId}...`);
        let val = await fetchPointCoverage(lineGeom[i], c);
        results[val] = (results[val] || 0) + 1;
    }
    // Determinar la cobertura predominante en los v√©rtices
    let dominant = 'SIN_DATO'; let max = 0;
    for(let v in results) { if(results[v] > max) { max = results[v]; dominant = v; } }
    return { [dominant]: 1 };
}

// ==========================================
// SPATIAL ANALYSIS ENGINE
// ==========================================
async function triggerSpatialAnalysis() {
    const c = document.getElementById('report-container');
    const btn = document.getElementById('btn-download-report');
    if (!data.points.length && !data.lines.length && !data.polygons.length) {
        return c.innerHTML = '<p style="text-align:center; padding:30px; color:var(--text-muted);">No hay datos ingresados para analizar.</p>';
    }
    c.innerHTML = '<div class="spinner-container"><div class="loader"></div><p id="analysis-status-text" style="font-weight:bold; margin-top:12px; color:var(--primary);">Iniciando motor de muestreo...</p></div>';
    btn.style.display = 'none';

    try {
        globalAnalysisResults = await runSpatialAnalysis();
        renderAnalysisUI(globalAnalysisResults);
        btn.style.display = 'block';
    } catch(e) {
        c.innerHTML = `<p style="color:red; text-align:center; padding:20px;">Error cr√≠tico en el an√°lisis: ${e.message}</p>`;
    }
}

async function runSpatialAnalysis() {
    const statusEl = document.getElementById('analysis-status-text');
    const updateStatus = async (msg) => { statusEl.innerText = msg; await new Promise(r => setTimeout(r, 10)); };
    let res = { points: null, lines: null };

    // ANALISIS DE PUNTOS
    if (data.points.length > 0) {
        res.points = { ids: data.points.map(p => p.id), classif: {} };
        for (const c of config) {
            if (!c.enabled) continue;
            res.points.classif[c.name] = {};
            for (const p of data.points) {
                await updateStatus(`üìç Analizando Punto ${p.id} en capa ${c.name}...`);
                res.points.classif[c.name][p.id] = await fetchPointCoverage(p.geom, c);
            }
        }
    }
    
    // ANALISIS DE LINEAS (V√©rtices)
    if (data.lines.length > 0) {
        res.lines = { ids: data.lines.map(l => l.id), classif: {} };
        for (const c of config) {
            if (!c.enabled) continue;
            res.lines.classif[c.name] = {};
            for (const l of data.lines) {
                const covs = await fetchLineCoverages(l.geom, c, l.id, updateStatus);
                const dominant = Object.keys(covs)[0] || 'SIN_DATO';
                if (!res.lines.classif[c.name][dominant]) res.lines.classif[c.name][dominant] = {};
                res.lines.classif[c.name][dominant][l.id] = 1;
            }
        }
    }
    
    await updateStatus("Generando reporte y ensamblando tablas...");
    return res;
}

// ==========================================
// RENDERIZADO DE TABLAS Y EXPORTACION
// ==========================================
function renderAnalysisUI(results) {
    const container = document.getElementById('report-container');
    let html = '';
    const enabledConfig = config.filter(c => c.enabled);
    
    if(results.points) {
        html += '<div class="report-section"><h4>üìç Puntos</h4><div class="report-table-wrapper"><table class="report-table"><thead><tr><th>ID</th>';
        enabledConfig.forEach(c => html += `<th>${c.name}</th>`);
        html += '</tr></thead><tbody>';
        results.points.ids.forEach(id => {
            html += `<tr><td><b>${id}</b></td>`;
            enabledConfig.forEach(c => html += `<td>${results.points.classif[c.name][id]}</td>`);
            html += '</tr>';
        });
        html += '</tbody></table></div></div>';
    }
    
    if(results.lines) {
        html += '<div class="report-section"><h4>üìà L√≠neas (Predominancia)</h4><div class="report-table-wrapper"><table class="report-table"><thead><tr><th>ID</th>';
        enabledConfig.forEach(c => html += `<th>${c.name}</th>`);
        html += '</tr></thead><tbody>';
        results.lines.ids.forEach(id => {
            html += `<tr><td><b>${id}</b></td>`;
            enabledConfig.forEach(c => {
                let val = 'SIN_DATO';
                for(let k in results.lines.classif[c.name]) {
                    if(results.lines.classif[c.name][k][id] === 1) val = k;
                }
                html += `<td>${val}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table></div></div>';
    }
    
    if(!results.points && !results.lines) {
         html = '<p style="text-align:center; padding:30px;">An√°lisis completado pero no se detectaron datos v√°lidos.</p>';
    }
    container.innerHTML = html;
}

function downloadReport() {
    const ws_data = [];
    const enabledConfig = config.filter(c => c.enabled);
    
    if(globalAnalysisResults.points) {
        ws_data.push(["RESULTADOS PUNTOS"]);
        let header = ["ID"].concat(enabledConfig.map(c => c.name));
        ws_data.push(header);
        globalAnalysisResults.points.ids.forEach(id => {
            let row = [id].concat(enabledConfig.map(c => globalAnalysisResults.points.classif[c.name][id]));
            ws_data.push(row);
        });
        ws_data.push([]);
        ws_data.push([]);
    }
    
    if(globalAnalysisResults.lines) {
        ws_data.push(["RESULTADOS LINEAS (Predominancia en v√©rtices)"]);
        let header = ["ID"].concat(enabledConfig.map(c => c.name));
        ws_data.push(header);
        globalAnalysisResults.lines.ids.forEach(id => {
            let row = [id];
            enabledConfig.forEach(c => {
                let val = 'SIN_DATO';
                for(let k in globalAnalysisResults.lines.classif[c.name]) {
                    if(globalAnalysisResults.lines.classif[c.name][k][id] === 1) val = k;
                }
                row.push(val);
            });
            ws_data.push(row);
        });
    }
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Reporte GIS Cobertura");
    XLSX.writeFile(wb, "GIS_Cobertura_Resultados.xlsx");
}

</script>
</body>
</html>
